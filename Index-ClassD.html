<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Congress Simulation Lightboard (180 Bills)</title>

  <!-- Firebase compat libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #fff; margin: 20px; }
    h1 { text-align: center; margin-bottom: 10px; }
    .top-container { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 15px; }
    .committee-panel { flex: 1; padding: 10px; border-radius: 8px; background: #1b1b1b; max-height: 400px; overflow-y: auto; }
    .house-panel { border: 2px solid #00c853; }
    .senate-panel { border: 2px solid #2196f3; }
    .committee-panel h3 { text-align: center; margin-top: 0; cursor: pointer; }
    .committee-list { min-height: 60px; background: #222; padding: 8px; border-radius: 6px; font-size: 0.9em; }
    .collapsed { display: none; }
    .controls { text-align: center; margin-bottom: 10px; }
    button { background: #d50000; color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer; font-weight: bold; }
    button:hover { background: #ff1744; }
    .dashboard { text-align: center; margin-bottom: 15px; font-weight: bold; }
    .bill-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px; }
    .bill { border: 1px solid #444; border-radius: 10px; padding: 10px; background: #222; }
    .bill h2 { text-align: center; font-size: 1.1em; margin-bottom: 10px; }
    .actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; text-align: center; }
    .light-wrapper { display: flex; flex-direction: column; align-items: center; }
    .light { width: 25px; height: 25px; border-radius: 50%; background: gray; cursor: pointer; border: 2px solid #555; margin-bottom: 4px; }
    .light.green { background: #00c853; }
    .light.red { background: #d50000; }
    .light.gray { background: gray; }
    .status { margin-top: 6px; text-align: center; font-weight: bold; }
    .status.green { color: #00c853; }
    .status.red { color: #d50000; }
    .status.yellow { color: #ffd600; }
    .status.gray { color: gray; }
  </style>
</head>

<body>
  <h1>Congressional Lightboard Tracker</h1>

  <div class="top-container">
    <div class="committee-panel house-panel">
      <h3 onclick="this.nextElementSibling.classList.toggle('collapsed')">üèõÔ∏è House Committee Passed</h3>
      <div id="houseCommitteeList" class="committee-list"></div>
    </div>
    <div class="committee-panel senate-panel">
      <h3 onclick="this.nextElementSibling.classList.toggle('collapsed')">üèõÔ∏è Senate Committee Passed</h3>
      <div id="senateCommitteeList" class="committee-list"></div>
    </div>
  </div>

  <div class="controls">
    <button id="resetBtn">üîÅ Reset All Bills</button>
    <button id="saveBtn">‚òÅÔ∏è Save to Cloud</button>
  </div>

  <div class="dashboard" id="dashboard">No Action: 0 | In Progress: 0 | Failed: 0 | Law: 0</div>
  <div id="lightboard" class="bill-container"></div>

  <script>
    // ---- Firebase Init ----
    const firebaseConfig = {
      apiKey: "AIzaSyB0Scx7kkt3yY0TVIrPTMLtER1sqBW31cU",
      authDomain: "congreightboard.firebaseapp.com",
      projectId: "congreightboard",
      storageBucket: "congreightboard.appspot.com",
      messagingSenderId: "442171722171",
      appId: "1:442171722171:web:167640f2e6986056605c9e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ---- Core Logic ----
    const CLASS_ID = "ClassD";
    const actionList = [
      { name: "Introduced (H)", key: "introH" },
      { name: "Introduced (S)", key: "introS" },
      { name: "Committee (H)", key: "commH" },
      { name: "Committee (S)", key: "commS" },
      { name: "Amendments (H)", key: "amendH" },
      { name: "Amendments (S)", key: "amendS" },
      { name: "Passed (H)", key: "passedH" },
      { name: "Passed (S)", key: "passedS" },
      { name: "Signed (P)", key: "signedP" }
    ];
    let houseSelectionOrder = [];
    let senateSelectionOrder = [];

    function createBillElement(billNumber, savedData) {
      const billDiv = document.createElement("div");
      billDiv.className = "bill";
      const title = document.createElement("h2");
      title.textContent = "Bill " + billNumber;
      billDiv.appendChild(title);

      const actionsDiv = document.createElement("div");
      actionsDiv.className = "actions";
      const lights = [];

      actionList.forEach(actionObj => {
        const wrap = document.createElement("div");
        wrap.className = "light-wrapper";
        const light = document.createElement("div");
        light.className = "light gray";
        light.dataset.key = actionObj.key;
        light.title = actionObj.name;
        wrap.appendChild(light);
        const label = document.createElement("div");
        label.style.fontSize = "0.65em";
        label.textContent = actionObj.name;
        wrap.appendChild(label);

        light.addEventListener("click", () => {
          const current = light.classList.contains("gray") ? "gray" :
            light.classList.contains("green") ? "green" : "red";
          const next = current === "gray" ? "green" : current === "green" ? "red" : "gray";
          light.className = `light ${next}`;
          updateOverallStatus(billDiv);
          updateCommitteeLists();
          updateDashboard();
        });

        actionsDiv.appendChild(wrap);
        lights.push(light);
      });

      billDiv.appendChild(actionsDiv);
      const statusDiv = document.createElement("div");
      statusDiv.className = "status gray";
      statusDiv.textContent = "No Action";
      billDiv.appendChild(statusDiv);
      billDiv.lights = lights;
      billDiv.statusDiv = statusDiv;

      if (savedData) {
        actionList.forEach((a, i) => {
          if (savedData[i]) lights[i].className = `light ${savedData[i]}`;
        });
        updateOverallStatus(billDiv);
      }

      return billDiv;
    }

    function updateOverallStatus(billDiv) {
      const lights = billDiv.lights;
      const getColor = k => lights.find(l => l.dataset.key === k)?.classList[1];
      const introH = getColor("introH"), introS = getColor("introS");
      const passedH = getColor("passedH"), passedS = getColor("passedS"), signedP = getColor("signedP");
      const introduced = introH === "green" || introS === "green";
      const bothFailed = passedH === "red" && passedS === "red";
      const bothPassed = passedH === "green" && passedS === "green";
      const failedPresident = signedP === "red";
      let color = "yellow", text = "In Progress";
      if (!introduced) { color = "gray"; text = "No Action"; }
      else if (bothFailed || failedPresident) { color = "red"; text = "Failed"; }
      else if (bothPassed && signedP === "green") { color = "green"; text = "Law"; }
      billDiv.statusDiv.className = `status ${color}`;
      billDiv.statusDiv.textContent = text;
    }

    function updateCommitteeLists() {
      const houseList = document.getElementById("houseCommitteeList");
      const senateList = document.getElementById("senateCommitteeList");
      houseList.innerHTML = "";
      senateList.innerHTML = "";
      const allBills = document.querySelectorAll(".bill");

      allBills.forEach(bill => {
        const lights = bill.lights;
        const getColor = k => lights.find(l => l.dataset.key === k)?.classList[1];
        const commH = getColor("commH"), commS = getColor("commS");
        const passedH = getColor("passedH"), passedS = getColor("passedS");
        const amendH = getColor("amendH"), amendS = getColor("amendS");
        const billNum = bill.querySelector("h2").textContent;
        if (commH === "green" || passedS === "green") {
          if (!houseSelectionOrder.includes(billNum)) houseSelectionOrder.push(billNum);
        } else { houseSelectionOrder = houseSelectionOrder.filter(n => n !== billNum); }
        if (commS === "green" || passedH === "green") {
          if (!senateSelectionOrder.includes(billNum)) senateSelectionOrder.push(billNum);
        } else { senateSelectionOrder = senateSelectionOrder.filter(n => n !== billNum); }
      });

      houseSelectionOrder.forEach(num => {
        const bill = Array.from(allBills).find(b => b.querySelector("h2").textContent === num);
        const amendH = bill.lights.find(l => l.dataset.key === "amendH").classList[1];
        const passedS = bill.lights.find(l => l.dataset.key === "passedS").classList[1];
        const div = document.createElement("div");
        div.textContent = num + (amendH === "green" ? " *" : "") + (passedS === "green" ? " +" : "");
        houseList.appendChild(div);
      });
      senateSelectionOrder.forEach(num => {
        const bill = Array.from(allBills).find(b => b.querySelector("h2").textContent === num);
        const amendS = bill.lights.find(l => l.dataset.key === "amendS").classList[1];
        const passedH = bill.lights.find(l => l.dataset.key === "passedH").classList[1];
        const div = document.createElement("div");
        div.textContent = num + (amendS === "green" ? " *" : "") + (passedH === "green" ? " +" : "");
        senateList.appendChild(div);
      });
    }

    function updateDashboard() {
      const allBills = document.querySelectorAll(".bill");
      let noAction = 0, inProgress = 0, failed = 0, law = 0;
      allBills.forEach(bill => {
        const s = bill.statusDiv.textContent;
        if (s === "No Action") noAction++;
        else if (s === "In Progress") inProgress++;
        else if (s === "Failed") failed++;
        else if (s === "Law") law++;
      });
      document.getElementById("dashboard").textContent =
        `No Action: ${noAction} | In Progress: ${inProgress} | Failed: ${failed} | Law: ${law}`;
    }

    async function saveToFirebase() {
      const allBills = document.querySelectorAll(".bill");
      const saveObj = {};
      allBills.forEach(b => {
        const num = b.querySelector("h2").textContent.split(" ")[1];
        saveObj[num] = [...b.querySelectorAll(".light")].map(l => l.classList[1]);
      });
      try {
        await db.collection("lightboard").doc(CLASS_ID).set({ data: saveObj });
        alert("‚úÖ Progress saved to Firebase");
      } catch (e) { alert("‚ùå Save failed: " + e.message); }
    }

    async function loadFromFirebase() {
      const docSnap = await db.collection("lightboard").doc(CLASS_ID).get();
      return docSnap.exists ? docSnap.data().data : {};
    }

    function resetAll() {
      if (confirm("Reset all bills?")) {
        db.collection("lightboard").doc(CLASS_ID).set({ data: {} });
        location.reload();
      }
    }

    async function initializeBoard() {
      const savedData = await loadFromFirebase();
      const lightboard = document.getElementById("lightboard");
      for (let i = 101; i <= 280; i++) {
        lightboard.appendChild(createBillElement(i, savedData[i]));
      }
      updateDashboard();
      updateCommitteeLists();
    }

    document.addEventListener("DOMContentLoaded", () => {
      initializeBoard();
      document.getElementById("saveBtn").addEventListener("click", saveToFirebase);
      document.getElementById("resetBtn").addEventListener("click", resetAll);
    });
  </script>
</body>
</html>